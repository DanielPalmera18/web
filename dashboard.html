<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Equipos Biom√©dicos</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <header>
        <h1>Equipos Biom√©dicos</h1>
        <nav>
            <a href="agregar_equipo.html" class="btn">‚ûï Agregar Equipo</a>
            <button id="logoutBtn" class="btn btn-danger">üö™ Cerrar Sesi√≥n</button>
        </nav>
    </header>

    <main class="container">
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="üîç Buscar por serie..." class="search-input">
        </div>
        
        <table class="equipos-table">
            <thead>
                <tr>
                    <th>Serie</th>
                    <th>Nombre</th>
                    <th>Marca</th>
                    <th>Ubicaci√≥n</th>
                    <th>Condici√≥n</th>
                    <th>Pr√≥ximo Servicio</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="equipos-body">
                <!-- Datos cargados por JavaScript -->
            </tbody>
        </table>
    </main>

    <script type="module">
        import { getEquipos, deleteEquipo, searchEquipos } from './js/data.js';
        import { logout } from './js/auth.js';

        // Funci√≥n segura para obtener clases CSS
        const getSafeClass = (value) => {
            if (!value) return '';
            return String(value).toLowerCase().replace(/[^a-z0-9]/g, '-');
        };

        // Funci√≥n para formatear fecha
        const formatDate = (dateString) => {
            if (!dateString) return 'N/A';
            try {
                return new Date(dateString).toLocaleDateString('es-ES');
            } catch {
                return 'N/A';
            }
        };

        async function renderEquipos(equipos = []) {
            const tbody = document.getElementById("equipos-body");
            
            if (equipos.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="no-data">
                            No hay equipos registrados
                            <br>
                            <a href="agregar_equipo.html" class="btn">Agregar primer equipo</a>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = equipos.map(equipo => `
                <tr>
                    <td>${equipo.serie}</td>
                    <td>${equipo.nombre}</td>
                    <td>${equipo.marca}</td>
                    <td>
                        <span class="estado ${getSafeClass(equipo.ubicacion)}">
                            ${equipo.ubicacion}
                        </span>
                    </td>
                    <td>
                        <span class="estado ${getSafeClass(equipo.condicion)}">
                            ${equipo.condicion}
                        </span>
                    </td>
                    <td class="${equipo.fecha_proximo && new Date(equipo.fecha_proximo) < new Date() ? 'vencido' : ''}">
                        ${formatDate(equipo.fecha_proximo)}
                    </td>
                    <td>
                        <div class="botones-accion">
                            <a href="detalle_equipo.html?id=${equipo.id}" class="btn btn-info">üëÅÔ∏è</a>
                            <a href="editar_equipo.html?id=${equipo.id}" class="btn btn-editar">‚úèÔ∏è</a>
                            <button onclick="eliminarEquipo('${equipo.id}')" class="btn btn-eliminar">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>
            `).join("");
        }

        // Eventos
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const equipos = await getEquipos();
                await renderEquipos(equipos);
            } catch (error) {
                console.error("Error:", error);
                document.getElementById("equipos-body").innerHTML = `
                    <tr>
                        <td colspan="7" class="error">
                            Error al cargar equipos: ${error.message}
                        </td>
                    </tr>
                `;
            }
        });

        document.getElementById("searchInput").addEventListener('input', async (e) => {
            const term = e.target.value.trim();
            const resultados = term ? await searchEquipos(term) : await getEquipos();
            renderEquipos(resultados);
        });

        document.getElementById("logoutBtn").addEventListener('click', logout);

        window.eliminarEquipo = async (id) => {
            if (confirm('¬øEliminar este equipo?')) {
                await deleteEquipo(id);
                const equipos = await getEquipos();
                renderEquipos(equipos);
            }
        };
    </script>
</body>
</html>
